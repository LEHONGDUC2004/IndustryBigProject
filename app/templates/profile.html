{% extends 'indexLogin.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}"/>
<meta name="is-authenticated" content="{{ 'true' if current_user.is_authenticated else 'false' }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block changeCloumn %}
<nav class="bg-gray-900 border-b border-gray-800">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center space-x-8">
      <a href="/overview" class="py-4 px-1 text-sm font-medium text-gray-400 hover:text-white hover:border-gray-500 border-b-2 border-transparent">Overview</a>
      <a href="/indexLogin" class="py-4 px-1 text-sm font-medium hover:border-b-2 hover:border-blue-500 hover:text-white">Deployments</a>
      <a href="/success" class="py-4 px-1 text-sm font-medium text-gray-400 hover:text-white hover:border-gray-500 border-b-2 border-transparent">Activity</a>
      <a href="#" class="py-4 px-1 text-sm font-medium text-gray-400 hover:text-white hover:border-gray-500 border-b-2 border-transparent">Domains</a>
      <a href="{{ url_for('main.profile', tab='info') }}" class="py-4 px-1 text-sm font-medium text-white border-blue-500 border-b-2">Settings</a>
    </div>
  </div>
</nav>
{% endblock %}

{% block profile %}
<div class="container py-5">
  <h2 class="display-5 fw-bold mb-4">Hồ Sơ Của Tôi</h2>

  <div class="row g-4">
    <!-- Sidebar -->
    <div class="col-md-3">
      <div class="card card-body text-center shadow-sm profile-sidebar">
        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center text-white fs-1 fw-bold mx-auto mb-3" style="width:120px;height:120px;">
          {{ (user.name or user.name_account or 'U')[0] }}
        </div>
        <h4 class="fw-bold">{{ user.name or user.name_account }}</h4>

        <div class="nav flex-column nav-pills mt-3">
          <a href="{{ url_for('main.profile', tab='info') }}" class="nav-link {% if tab == 'info' %}active{% endif %}">Thông tin cá nhân</a>
          <a href="{{ url_for('main.profile', tab='security') }}" class="nav-link {% if tab == 'security' %}active{% endif %}">Đổi Mật Khẩu</a>
          <a href="/indexLogin" class="nav-link">Thoát</a>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="col-md-9">
      <div class="card card-body shadow-sm p-4">

        {% if success_msg %}
          <div class="alert alert-success alert-dismissible fade show">
            {{ success_msg }} <button class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% elif error_msg %}
          <div class="alert alert-danger alert-dismissible fade show">
            {{ error_msg }} <button class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endif %}

        {% if tab == 'info' %}
          <h3 class="fw-bold mb-4">Chỉnh sửa thông tin</h3>

          <form class="row g-3" method="POST" action="{{ url_for('main.profile', tab='info') }}">
            <div class="col-md-6">
              <label class="form-label">Họ và tên</label>
              <input type="text" name="name"
                     value="{{ draft.get('name', user.name or '') }}"
                     class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" name="email"
                     value="{{ draft.get('email', user.email or '') }}"
                     class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Ngày sinh</label>
              <input type="date" name="dob"
                     value="{{ draft.get('dob', (user.dob.strftime('%Y-%m-%d') if user.dob else '')) }}"
                     class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Số điện thoại</label>
              <input type="tel" name="phone"
                     value="{{ draft.get('phone', user.phone or '') }}"
                     class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Địa chỉ</label>
              <input type="text" name="address" id="address"
                     value="{{ draft.get('address', user.address or '') }}"
                     class="form-control" oninput="updateMap()">
            </div>

            <div class="col-12">
              <iframe id="mapFrame" width="100%" height="300" style="border:0;" allowfullscreen loading="lazy"
                      src="https://www.google.com/maps?q={{ (draft.get('address', user.address or '')) | urlencode }}&output=embed"></iframe>
            </div>

            <div class="col-12 text-end mt-4 d-flex gap-2 justify-content-end">
              <button type="submit" class="btn btn-outline-secondary" name="action" value="clear_draft">Xóa</button>
              <button type="submit" class="btn btn-primary" name="action" value="save_db">Lưu thay đổi</button>
            </div>
          </form>

        {% elif tab == 'security' %}
          <h3 class="fw-bold mb-4">Đổi mật khẩu</h3>

          <form class="row g-3" method="POST" action="{{ url_for('main.profile', tab='security') }}">
            <div class="col-12">
              <label class="form-label">Mật khẩu cũ</label>
              <input type="password" name="old_password" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Mật khẩu mới</label>
              <input type="password" name="new_password" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Xác nhận mật khẩu mới</label>
              <input type="password" name="confirm_password" class="form-control" required>
            </div>

            <div class="col-12 text-end mt-4 d-flex gap-2 justify-content-end">
              <button type="submit" class="btn btn-primary" name="action" value="save_pw_db">Đổi mật khẩu</button>
            </div>
          </form>

        {% else %}
          <p class="text-muted">Tab không hợp lệ.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
